#!/bin/sh

set -e

# == CONFIGURATION ==

RESTIC=/usr/bin/restic
TEST_FROM="/tmp/restic-slow-fromdir"
TEST_DEST="/tmp/restic-slow-destdir"
LOGFILE="timing_$(date "+%Y%m%d_%H%M%S").log"

echo "Using command '${RESTIC}'."

# == CLEANUP ==

rm -rf "${TEST_FROM}" "${TEST_DEST}"

# == SETUP: fromdir ==

mkdir "${TEST_FROM}"
for i in $(seq 20)
do
    DSTFILE="$(mktemp "${TEST_FROM}"/important_file_XXXXXXX.txt)"
    shuf -n3 <<EOF > "${DSTFILE}"
Hello, World!
foobar
Not something very interesting.
Hello!
Yes, hello?
Who is there?
Surely, you can't be serious!
I am serious.
And stop calling me Shirly!
This is a self-descriptive line.
Lorem ipsum
Dolor sit something something.
The quick brown fox.
Jumped over by the lazy dogs.
This sentence is an anagram for itself.
EOF
done

# == SETUP: destdir ==

mkdir "${TEST_DEST}"
export RESTIC_REPOSITORY="${TEST_DEST}"
export RESTIC_PASSWORD="1234"
${RESTIC} init

# == EXECUTE ==

${RESTIC} version | tee "${LOGFILE}"

ITERATIONS=300
for i in $(seq ${ITERATIONS})
do
    echo "Iteration $i / ${ITERATIONS}"
    date
    ${RESTIC} backup "${TEST_FROM}" > /dev/null
    /usr/bin/time restic check
done 2>&1 | tee -a "${LOGFILE}"

echo "Results have been copied to: ${LOGFILE}"
